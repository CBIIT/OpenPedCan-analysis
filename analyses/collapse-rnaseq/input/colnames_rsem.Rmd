---
title: "GTEx renaming"
output: html_notebook
---

In this notebook we will subset `gtex_target_tcga-gene-counts-rsem-expected_count-collapsed.rds` from v4 release to only samples that have Kids_First_Biospecimen_ID ( GTEX Barcode ) assigned in `histologies.tsv`

```{r}
# mapping GTEX from barcode to sample_id
mapping_KR <- read_tsv("input/gtex_mapping.txt")
gtex_JL_processed <- read_tsv("input/GTEx_v8_Cerebellum_AdrenalGland.manifest - GTEx_v8_Cerebellum_AdrenalGland.manifest.tsv")

# mapping TARGET from barcode to sample_id
mapping_Apexa <- read_tsv("input/target_mapping.1.txt")
mapping_AF <- read_tsv("input/target_mapping.2.txt")

# mapping TCGA from barcode to sample_id
mapping_tcga_KR <- read_tsv("input/tcga_mapping.txt")

# get duplicated tcg
duplicated_tcga <- read_tsv("input/tcga_duplicated.txt")

#colnames iin rsem
colnames_rsem <- read_tsv("input/")
```


## Subset histology from OT
```{r}
histology_gtex <- read_tsv("input/histologies.tsv", guess_max = 10000) %>% 
  filter(cohort=="GTEx",experimental_strategy=="RNA-Seq") %>%
  left_join(mapping_KR,by=c("Kids_First_Biospecimen_ID"="sample_barcode")) 

histology_target <- read_tsv("input/histologies.tsv", guess_max = 10000) %>% 
  filter(cohort=="TARGET",experimental_strategy=="RNA-Seq") %>%
  left_join(mapping_Apexa,by=c("Kids_First_Biospecimen_ID"="sample_barcode")) %>%
  left_join(mapping_AF,by=c("Kids_First_Biospecimen_ID"="sample_barcode"))

histology_tcga <- read_tsv("input/histologies.tsv", guess_max = 10000) %>% 
  filter(cohort=="TCGA",experimental_strategy=="RNA-Seq") %>%
  left_join(mapping_tcga_KR,by=c("Kids_First_Biospecimen_ID"="sample_barcode")) %>%
  # remove the duplicated tcga ids
  filter(!Kids_First_Biospecimen_ID %in% duplicated_tcga$Kids_First_Biospecimen_ID)

```

## GTEx rename sample_ids in rds  file  to barcode
```{r}
# get col index to rename  
rename_cols_index_gtex <- which(colnames(read_tpm) %in% histology_gtex$sample_id.y[!is.na(histology_gtex$sample_id.y)])
# get colnames for samples that don't match histology
remove_cols_gtex <-setdiff(mapping_KR$sample_id,
                           histology_gtex$sample_id.y)


# get barcode to replace colnames  
rename_cols_barcode_gtex <-unlist(lapply (
  colnames(read_tpm)[rename_cols_index_gtex] ,
  function(x) 
    as.character(histology_gtex[grep(x, histology_gtex$sample_id.y),
                                "Kids_First_Biospecimen_ID"])
  )
)


